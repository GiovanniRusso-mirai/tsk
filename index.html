<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSK Ryu - Iscrizioni Torneo</title>
    <style>
        :root { --primary: #d32f2f; --accent: #1a237e; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); padding: 20px; color: #333; }
        .container { max-width: 850px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; }
        .header { text-align: center; padding: 25px; border-bottom: 5px solid var(--primary); background: #fff; }
        .logo { max-width: 120px; margin-bottom: 10px; }
        .form-section { padding: 30px; }
        .atleta-card { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 25px; margin-bottom: 25px; position: relative; transition: border-color 0.3s; }
        .atleta-card:hover { border-color: var(--accent); }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; background: #fdfdfd; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .checkbox-item input { width: auto; margin: 0; cursor: pointer; transform: scale(1.2); }
        label { display: block; font-size: 0.75rem; font-weight: 700; margin-bottom: 8px; color: #666; text-transform: uppercase; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        input:focus { border-color: var(--accent); outline: none; }
        .btn-submit { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 1.2rem; transition: background 0.3s; }
        .btn-submit:hover { background: #b71c1c; }
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); backdrop-filter: blur(5px); justify-content:center; align-items:center; z-index:100; }
        .modal-box { background:white; padding:35px; border-radius:15px; max-width:550px; width:90%; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .recap-item { border-bottom: 1px solid #eee; padding: 10px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://scontent-fco2-1.xx.fbcdn.net/v/t39.30808-6/299940804_510546830876553_8892043649465700842_n.png?_nc_cat=109&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=KfRaKBcy4bYQ7kNvwFtD0vT&_nc_oc=AdkaCiXWCryfJoULFVYg7WqF66mFvgnD73pCypsoJexFYoXcJK4hiXQ1fWi0T7RxClU&_nc_zt=23&_nc_ht=scontent-fco2-1.xx&_nc_gid=BSB6zC-CWoJRDzEBzyPNbA&oh=00_AftdHc8vIl8F0rP-oic5rZgt9rrt7UQ2uuNWmDMUb5rHiQ&oe=6983C883" alt="Logo TSK" class="logo">
        <h2 style="color:var(--accent); margin:10px 0; font-size: 1.8rem;">TAI SHIN DO KAI RYU</h2>
        <p style="margin:0; font-weight: bold; color: #666;">MODULO ISCRIZIONE ATLETI</p>
    </div>

    <form id="torneoForm" class="form-section">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:30px;">
            <div><label>Palestra / ASD</label><input type="text" id="palestra" placeholder="Nome Palestra" required></div>
            <div><label>Responsabile Tecnico</label><input type="text" id="responsabile" placeholder="Nome e Cognome" required></div>
        </div>

        <div id="listaAtleti"></div>

        <button type="button" onclick="renderAtleta()" style="width:100%; padding:15px; margin-bottom:20px; background:#fff; border:2px dashed var(--accent); color: var(--accent); cursor:pointer; font-weight:bold; border-radius:10px;">+ AGGIUNGI ATLETA ALLA LISTA</button>
        <button type="button" class="btn-submit" onclick="validazioneEAnteprima()">REVISIONE E INVIO DATI</button>
    </form>
</div>

<div id="modal">
    <div class="modal-box">
        <div id="recapSpace"></div>
    </div>
</div>

<script>
    // URL aggiornato con il tuo ultimo deploy
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyy9TpDCSXKG6hJCq3M16hL9hx4icWzBfI_SiYhjc5xKa7ViopcrHsu2K8-gg0Mhbk-kw/exec";

    function renderAtleta() {
        const container = document.getElementById('listaAtleti');
        const count = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'atleta-card';
        div.innerHTML = `
            <button type="button" onclick="this.parentElement.remove()" style="position:absolute; top:15px; right:15px; color:#d32f2f; border:none; background:none; cursor:pointer; font-weight:bold;">ELIMINA</button>
            <label style="color:var(--accent); font-size: 1rem;">ISCRIZIONE ATLETA #${count}</label>
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px; margin-bottom:20px; margin-top:10px;">
                <div><label>Nome e Cognome</label><input type="text" class="nome" required></div>
                <div><label>Peso (kg)</label><input type="number" class="peso" step="0.1" required></div>
                <div><label>Età</label><input type="number" class="eta" required></div>
            </div>
            <label>Discipline Selezionate (Anche Multiple):</label>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" class="gara" value="Kumitè Kids"> Kumitè Kids</label>
                <label class="checkbox-item"><input type="checkbox" class="gara" value="Kick Jitsu"> Kick Jitsu</label>
                <label class="checkbox-item"><input type="checkbox" class="gara" value="Lotta a terra"> Lotta a terra</label>
            </div>
        `;
        container.appendChild(div);
    }

    function validazioneEAnteprima() {
        const palestra = document.getElementById('palestra').value;
        const responsabile = document.getElementById('responsabile').value;
        const cards = document.getElementsByClassName('atleta-card');
        
        if(!palestra || !responsabile) return alert("Inserisci i dati della Palestra e del Responsabile!");
        if(cards.length === 0) return alert("Aggiungi almeno un atleta prima di inviare!");

        let recap = `<h2 style="color:var(--accent); margin-top:0;">Riepilogo Iscrizioni</h2><p><b>Palestra:</b> ${palestra}</p><div style="max-height:300px; overflow-y:auto; margin-bottom:20px; border-top:1px solid #eee;">`;
        let valid = true;

        for (let card of cards) {
            const nome = card.querySelector('.nome').value;
            const peso = card.querySelector('.peso').value;
            const eta = card.querySelector('.eta').value;
            const selezionate = Array.from(card.querySelectorAll('.gara:checked')).map(c => c.value);
            
            if(!nome || !peso || !eta || selezionate.length === 0) {
                alert("Compila tutti i campi e seleziona almeno una gara per ogni atleta!");
                valid = false; break;
            }
            recap += `<div class="recap-item"><b>${nome}</b> (${peso}kg, ${eta} anni)<br><small>Discipline: ${selezionate.join(', ')}</small></div>`;
        }

        if(valid) {
            recap += `</div>`;
            document.getElementById('recapSpace').innerHTML = recap + `
                <button onclick="invioFinale()" style="width:100%; padding:15px; background:#27ae60; color:white; border:none; border-radius:8px; margin-top:10px; font-weight:bold; cursor:pointer; font-size:1.1rem;">CONFERMA E INVIA ORA</button>
                <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; margin-top:10px; background:none; border:none; cursor:pointer; color:#666; font-weight:bold;">TORNA ALLA MODIFICA</button>`;
            document.getElementById('modal').style.display = 'flex';
        }
    }

    async function invioFinale() {
        const payload = {
            palestra: document.getElementById('palestra').value,
            responsabile: document.getElementById('responsabile').value,
            atleti: Array.from(document.getElementsByClassName('atleta-card')).map(card => ({
                nome: card.querySelector('.nome').value,
                peso: card.querySelector('.peso').value,
                eta: card.querySelector('.eta').value,
                gare: Array.from(card.querySelectorAll('.gara:checked')).map(c => c.value)
            }))
        };

        document.getElementById('recapSpace').innerHTML = "<h2 style='text-align:center;'>TRASMISSIONE DATI...</h2><p style='text-align:center;'>Attendere la conferma, non chiudere la pagina.</p>";
        
        try {
            await fetch(GOOGLE_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify(payload) 
            });
            alert("ISCRIZIONI INVIATE CON SUCCESSO ALLA TAI SHIN DO KAI RYU!");
            location.reload();
        } catch (err) {
            alert("Errore di connessione. Riprova.");
            document.getElementById('modal').style.display = 'none';
        }
    }

    // Inizializza con la prima scheda atleta
    renderAtleta();
</script>
</body>
</html>
