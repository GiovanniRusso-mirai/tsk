<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSK Ryu - Iscrizioni Torneo</title>
    <style>
        :root { --primary: #d32f2f; --accent: #1a237e; --bg: #f4f7f6; --white: #ffffff; }
        
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); color: #333; margin: 0; padding: 10px; }
        
        .container { max-width: 800px; margin: 0 auto; background: var(--white); border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); overflow: hidden; }
        
        .header { text-align: center; padding: 20px; border-bottom: 5px solid var(--primary); background: var(--white); position: sticky; top: 0; z-index: 100; }
        .logo { max-width: 80px; height: auto; }
        h1 { margin: 10px 0 5px; font-size: 1.2rem; color: var(--accent); text-transform: uppercase; }
        
        .form-section { padding: 20px; }
        
        /* Grid per Palestra e Responsabile */
        .grid-header { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        
        .atleta-card { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 20px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .atleta-card:hover { border-color: var(--accent); }
        
        /* Grid interna card atleta */
        .atleta-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        
        label { display: block; font-size: 0.7rem; font-weight: 700; margin-bottom: 5px; color: #666; text-transform: uppercase; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 8px; font-size: 1rem; outline: none; }
        input:focus { border-color: var(--accent); }

        .checkbox-group { display: flex; flex-direction: column; gap: 10px; background: #f9f9f9; padding: 12px; border-radius: 8px; }
        .checkbox-item { display: flex; align-items: center; gap: 10px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .checkbox-item input { width: 20px; height: 20px; cursor: pointer; }

        .btn-submit { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 1.1rem; margin-top: 10px; }
        .btn-add { width: 100%; padding: 12px; background: #fff; border: 2px dashed #ccc; color: #666; cursor: pointer; font-weight: bold; border-radius: 8px; margin-bottom: 15px; }

        /* Media Queries per Mobile */
        @media (max-width: 600px) {
            .grid-header { grid-template-columns: 1fr; }
            .atleta-grid { grid-template-columns: 1fr; }
            .header { padding: 15px; }
            h1 { font-size: 1rem; }
            .form-section { padding: 15px; }
        }

        /* Modal */
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:200; padding: 10px; }
        .modal-box { background:white; padding:20px; border-radius:12px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <img src="https://scontent-fco2-1.xx.fbcdn.net/v/t39.30808-6/299940804_510546830876553_8892043649465700842_n.png?_nc_cat=109&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=KfRaKBcy4bYQ7kNvwFtD0vT&_nc_oc=AdkaCiXWCryfJoULFVYg7WqF66mFvgnD73pCypsoJexFYoXcJK4hiXQ1fWi0T7RxClU&_nc_zt=23&_nc_ht=scontent-fco2-1.xx&_nc_gid=BSB6zC-CWoJRDzEBzyPNbA&oh=00_AftdHc8vIl8F0rP-oic5rZgt9rrt7UQ2uuNWmDMUb5rHiQ&oe=6983C883" alt="TSK Logo" class="logo">
        <h1>Tai Shin Do Kai Ryu</h1>
    </div>

    <form id="torneoForm" class="form-section">
        <div class="grid-header">
            <div><label>Palestra</label><input type="text" id="palestra" required></div>
            <div><label>Responsabile</label><input type="text" id="responsabile" required></div>
        </div>

        <div id="listaAtleti"></div>

        <button type="button" class="btn-add" onclick="renderAtleta()">+ AGGIUNGI ATLETA</button>
        <button type="button" class="btn-submit" onclick="validazioneEAnteprima()">REVISIONE E INVIO</button>
    </form>
</div>

<div id="modal"><div class="modal-box" id="recapSpace"></div></div>

<script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbyy9TpDCSXKG6hJCq3M16hL9hx4icWzBfI_SiYhjc5xKa7ViopcrHsu2K8-gg0Mhbk-kw/exec";

    function renderAtleta() {
        const container = document.getElementById('listaAtleti');
        const count = container.children.length + 1;
        const div = document.createElement('div');
        div.className = 'atleta-card';
        div.innerHTML = `
            <button type="button" onclick="this.parentElement.remove()" style="position:absolute; top:10px; right:10px; color:red; border:none; background:none; font-weight:bold; cursor:pointer;">X</button>
            <label style="color:var(--accent); margin-bottom:10px;">Atleta #${count}</label>
            <div class="atleta-grid">
                <div><label>Nome</label><input type="text" class="nome" required></div>
                <div><label>Peso kg</label><input type="number" class="peso" step="0.1" required></div>
                <div><label>Età</label><input type="number" class="eta" required></div>
            </div>
            <label>Discipline:</label>
            <div class="checkbox-group">
                <label class="checkbox-item"><input type="checkbox" class="gara" value="Kumitè Kids"> Kumitè Kids</label>
                <label class="checkbox-item"><input type="checkbox" class="gara" value="Kick Jitsu"> Kick Jitsu</label>
                <label class="checkbox-item"><input type="checkbox" class="gara" value="Lotta a terra"> Lotta a terra</label>
            </div>
        `;
        container.appendChild(div);
    }

    function validazioneEAnteprima() {
        const cards = document.getElementsByClassName('atleta-card');
        if(cards.length === 0) return alert("Aggiungi almeno un atleta!");
        
        let recap = `<h3>Riepilogo Iscrizioni</h3><div style="margin-bottom:20px; font-size:0.9rem;">`;
        let valid = true;

        for (let card of cards) {
            const nome = card.querySelector('.nome').value;
            const selezionate = Array.from(card.querySelectorAll('.gara:checked')).map(c => c.value);
            if(!nome || selezionate.length === 0) { valid = false; break; }
            recap += `<p style="border-bottom:1px solid #eee; padding:5px 0;"><b>${nome}</b>: ${selezionate.join(', ')}</p>`;
        }

        if(!valid) return alert("Controlla che ogni atleta abbia un nome e almeno una gara scelta.");

        document.getElementById('recapSpace').innerHTML = recap + `</div>
            <button onclick="invioFinale()" style="width:100%; padding:15px; background:green; color:white; border:none; border-radius:8px; font-weight:bold;">CONFERMA E INVIA ORA</button>
            <button onclick="document.getElementById('modal').style.display='none'" style="width:100%; background:none; border:none; color:#666; margin-top:10px; cursor:pointer;">Torna indietro</button>`;
        document.getElementById('modal').style.display = 'flex';
    }

    async function invioFinale() {
        const payload = {
            palestra: document.getElementById('palestra').value,
            responsabile: document.getElementById('responsabile').value,
            atleti: Array.from(document.getElementsByClassName('atleta-card')).map(card => ({
                nome: card.querySelector('.nome').value,
                peso: card.querySelector('.peso').value,
                eta: card.querySelector('.eta').value,
                gare: Array.from(card.querySelectorAll('.gara:checked')).map(c => c.value)
            }))
        };

        document.getElementById('recapSpace').innerHTML = "<h3>Invio in corso...</h3><p>Non chiudere la pagina.</p>";
        await fetch(GOOGLE_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("Iscrizioni inviate correttamente!");
        location.reload();
    }

    renderAtleta();
</script>
</body>
</html>
