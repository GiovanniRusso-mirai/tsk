<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSK DIRECTOR SYSTEM PRO</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --dark: #1a252f; --light: #f4f6f7; --blue: #3498db; --green: #27ae60; --red: #e74c3c; --orange: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; height: 100vh; display: flex; overflow: hidden; }

        /* SIDEBAR */
        aside { width: 280px; background: var(--dark); color: white; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
        .brand { padding: 20px; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #34495e; background: #151f28; }
        .filters { padding: 15px; border-bottom: 1px solid #34495e; }
        select, input { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: none; background: #34495e; color: white; }
        
        .cat-list { flex: 1; overflow-y: auto; }
        .cat-item { padding: 12px 20px; border-bottom: 1px solid #2c3e50; cursor: pointer; display: flex; justify-content: space-between; font-size: 0.9rem; transition: 0.2s; }
        .cat-item:hover { background: #2c3e50; }
        .cat-item.active { background: var(--blue); border-left: 5px solid white; }
        .badge { background: rgba(255,255,255,0.2); px; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; }

        /* MAIN BOARD */
        main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-pill { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .status-online { background: #d4edda; color: #155724; }
        .status-offline { background: #f8d7da; color: #721c24; }

        /* BRACKET VIEW */
        .bracket-container { display: flex; gap: 40px; overflow-x: auto; padding-bottom: 20px; }
        .round-column { min-width: 320px; display: flex; flex-direction: column; gap: 20px; }
        .round-title { font-weight: bold; text-transform: uppercase; color: #7f8c8d; border-bottom: 2px solid #bdc3c7; padding-bottom: 5px; margin-bottom: 10px; }

        /* MATCH CARD PRO */
        .match-card { background: white; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 5px solid #bdc3c7; position: relative; transition: 0.2s; }
        .match-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.15); }
        .match-card.completed { border-left-color: var(--green); }
        .match-card.ongoing { border-left-color: var(--orange); }

        .card-header { padding: 8px 12px; background: #f8f9fa; border-bottom: 1px solid #eee; font-size: 0.75rem; color: #666; display: flex; justify-content: space-between; }
        .card-body { padding: 0; }

        .athlete-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .athlete-row:last-child { border-bottom: none; }
        .athlete-row:hover { background: #f1f8ff; }
        
        .athlete-name { font-weight: 600; font-size: 0.95rem; }
        .athlete-club { font-size: 0.75rem; color: #999; display: block; }
        .score-box { font-weight: bold; font-size: 1.1rem; color: #333; min-width: 30px; text-align: center; }
        
        .winner-mark { color: var(--green); font-size: 1.2rem; display: none; }
        .athlete-row.winner .winner-mark { display: block; }
        .athlete-row.winner { background: #e8f5e9; }
        .athlete-row.loser { opacity: 0.5; }

        .next-match-indicator { position: absolute; right: -25px; top: 50%; width: 25px; height: 2px; background: #bdc3c7; z-index: -1; }

        /* ACTION MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .action-panel { background: white; width: 500px; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .panel-header { background: var(--dark); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .panel-body { padding: 20px; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .action-btn { padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; }
        .btn-win-red { background: #ffebee; color: var(--red); border: 1px solid var(--red); }
        .btn-win-blue { background: #e3f2fd; color: var(--blue); border: 1px solid var(--blue); }
        .btn-win-red:hover { background: var(--red); color: white; }
        .btn-win-blue:hover { background: var(--blue); color: white; }
        
        .btn-admin { background: #f8f9fa; color: #555; border: 1px solid #ddd; }
        .btn-admin:hover { background: #e2e6ea; }

        .method-select { margin-top: 15px; width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }

        /* UTILITIES */
        .hidden { display: none; }
    </style>
</head>
<body>

<aside>
    <div class="brand"><i class="fas fa-trophy"></i> TSK MANAGER</div>
    <div class="filters">
        <label style="font-size:0.8rem; color:#aaa;">DISCIPLINA</label>
        <select id="discFilter" onchange="renderCats()">
            <option value="ALL">Tutte</option>
            <option value="KICK JITSU">Kick Jitsu</option>
            <option value="LOTTA A TERRA">Lotta a Terra</option>
            <option value="KUMITE KIDS">Kumitè Kids</option>
        </select>
        <input type="text" id="searchCat" placeholder="Cerca Categoria..." onkeyup="renderCats()">
    </div>
    <div class="cat-list" id="catList">
        </div>
</aside>

<main>
    <div class="header-bar">
        <div>
            <h2 id="currentCatTitle" style="margin:0;">Seleziona una categoria</h2>
            <small id="currentCatInfo" style="color:#777;">...</small>
        </div>
        <div>
            <span id="syncStatus" class="status-pill status-offline"><i class="fas fa-wifi"></i> Offline</span>
            <button onclick="forceSave()" style="background:var(--blue); color:white; border:none; padding:8px 15px; border-radius:4px; margin-left:10px; cursor:pointer;"><i class="fas fa-save"></i> Salva Tutto</button>
        </div>
    </div>

    <div id="bracketView" class="bracket-container">
        </div>
</main>

<div id="matchModal" class="modal-overlay">
    <div class="action-panel">
        <div class="panel-header">
            <span id="modalMatchId">Gestione Match</span>
            <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;">&times;</button>
        </div>
        <div class="panel-body">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <div style="text-align:center; width:45%;">
                    <h3 id="modalP1" style="color:var(--red); margin:0;">Atleta Rosso</h3>
                    <small id="modalP1Club">Club</small>
                </div>
                <div style="font-weight:bold; font-size:1.5rem;">VS</div>
                <div style="text-align:center; width:45%;">
                    <h3 id="modalP2" style="color:var(--blue); margin:0;">Atleta Blu</h3>
                    <small id="modalP2Club">Club</small>
                </div>
            </div>

            <label>Metodo di Vittoria:</label>
            <select id="winMethod" class="method-select">
                <option value="PUNTI">Ai Punti / Decisione</option>
                <option value="SOTTOMISSIONE">Sottomissione / Ippon</option>
                <option value="SQUALIFICA">Squalifica Avversario</option>
                <option value="WALKOVER">Assenza Avversario (Walkover)</option>
                <option value="INFORTUNIO">Infortunio / Stop Medico</option>
            </select>

            <div class="action-grid">
                <button class="action-btn btn-win-red" onclick="setWinner('p1')">
                    <i class="fas fa-medal fa-2x"></i> VINCE ROSSO
                </button>
                <button class="action-btn btn-win-blue" onclick="setWinner('p2')">
                    <i class="fas fa-medal fa-2x"></i> VINCE BLU
                </button>
            </div>

            <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="action-btn btn-admin" onclick="editAthletes()">
                    <i class="fas fa-edit"></i> Modifica Nomi
                </button>
                <button class="action-btn btn-admin" onclick="resetMatch()" style="color:var(--red);">
                    <i class="fas fa-undo"></i> Resetta Match
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= CONFIGURAZIONE =================
    // INSERISCI QUI IL TUO URL GOOGLE SCRIPT
    const API_URL = "https://script.google.com/macros/s/AKfycbz792CwPJ2sirxZez2f1nKjDYIOe3rBHVxMHSSNMn2MIfL9UOPzGVJeQxB4HZGGR1Wk/exec";

    // Struttura Dati
    let db = []; // Contiene tutti i match
    let currentCat = null;
    let editingMatchId = null;

    // ================= INIZIALIZZAZIONE =================
    async function init() {
        document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync fa-spin"></i> Caricamento...';
        
        try {
            // 1. Prova a scaricare dal cloud
            const response = await fetch(API_URL + "?action=read");
            const data = await response.json();
            
            if(Array.isArray(data) && data.length > 0) {
                db = data;
                localStorage.setItem('tsk_db', JSON.stringify(db)); // Backup locale
                showStatus(true);
            } else {
                // Fallback se cloud vuoto (primo avvio)
                console.warn("Cloud vuoto, carico locale se esiste");
                const local = localStorage.getItem('tsk_db');
                if(local) db = JSON.parse(local);
            }
        } catch(e) {
            console.error("Errore Sync", e);
            const local = localStorage.getItem('tsk_db');
            if(local) db = JSON.parse(local);
            showStatus(false);
        }

        renderCats();
    }

    function showStatus(online) {
        const el = document.getElementById('syncStatus');
        if(online) {
            el.className = "status-pill status-online";
            el.innerHTML = '<i class="fas fa-wifi"></i> Online';
        } else {
            el.className = "status-pill status-offline";
            el.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Offline (Locale)';
        }
    }

    // ================= UI RENDER =================
    function renderCats() {
        const list = document.getElementById('catList');
        const filter = document.getElementById('discFilter').value;
        const search = document.getElementById('searchCat').value.toLowerCase();
        
        list.innerHTML = "";
        
        // Estrai categorie univoche
        const cats = [...new Set(db.map(m => m.c))].sort();

        cats.forEach(c => {
            const matches = db.filter(m => m.c === c);
            if(matches.length === 0) return;
            const disc = matches[0].d;

            if(filter !== "ALL" && disc !== filter) return;
            if(search && !c.toLowerCase().includes(search)) return;

            const div = document.createElement('div');
            div.className = `cat-item ${currentCat === c ? 'active' : ''}`;
            div.innerHTML = `<span>${c}</span> <span class="badge">${matches.length} match</span>`;
            div.onclick = () => loadCategory(c);
            list.appendChild(div);
        });
    }

    function loadCategory(c) {
        currentCat = c;
        renderCats(); // Aggiorna active class
        
        const matches = db.filter(m => m.c === c);
        document.getElementById('currentCatTitle').innerText = c;
        document.getElementById('currentCatInfo').innerText = matches[0].d + " - " + matches.length + " Incontri totali";

        const container = document.getElementById('bracketView');
        container.innerHTML = "";

        // Raggruppa per Round (R1, R2, Semifinali, Finale)
        // Logica di ordinamento: R1 < R2 < Quarti < Semifinali < Finale
        const roundsOrder = ["R1", "R2", "R3", "Quarti", "Semifinale", "Finale"];
        
        // Trova i round presenti
        const presentRounds = [...new Set(matches.map(m => m.r))].sort((a,b) => {
            return roundsOrder.indexOf(a) - roundsOrder.indexOf(b);
        });

        presentRounds.forEach(r => {
            const col = document.createElement('div');
            col.className = 'round-column';
            col.innerHTML = `<div class="round-title">${r}</div>`;
            
            matches.filter(m => m.r === r).forEach(match => {
                col.appendChild(createMatchCard(match));
            });
            
            container.appendChild(col);
        });
    }

    function createMatchCard(m) {
        const card = document.createElement('div');
        card.className = `match-card ${m.w ? 'completed' : ''}`;
        
        // Se è un BYE (match finto per avanzamento)
        const isBye = m.p2 === "BYE" || m.p2 === "";
        
        // Logica visualizzazione P1 e P2
        let p1Html = `
            <div class="athlete-row ${m.w === 'p1' ? 'winner' : (m.w ? 'loser' : '')}">
                <div>
                    <span class="athlete-name">${m.p1 || '<i style="color:#ccc">In attesa...</i>'}</span>
                    <span class="athlete-club">${m.p1i || ''}</span>
                </div>
                <div class="winner-mark"><i class="fas fa-check-circle"></i></div>
            </div>`;

        let p2Html = `
            <div class="athlete-row ${m.w === 'p2' ? 'winner' : (m.w ? 'loser' : '')}">
                <div>
                    <span class="athlete-name">${m.p2 || (isBye ? '<i style="color:#ccc">BYE</i>' : '<i style="color:#ccc">In attesa...</i>')}</span>
                    <span class="athlete-club">${m.p2i || ''}</span>
                </div>
                <div class="winner-mark"><i class="fas fa-check-circle"></i></div>
            </div>`;

        card.innerHTML = `
            <div class="card-header">
                <span>Match ${m.id}</span>
                ${m.note ? `<span style="color:red; font-weight:bold;">⚠️ ${m.note}</span>` : ''}
                <span style="cursor:pointer" onclick="openModal('${m.id}')"><i class="fas fa-cog"></i> Gestisci</span>
            </div>
            <div class="card-body">
                ${p1Html}
                ${p2Html}
            </div>
            ${m.method ? `<div style="padding:5px 10px; background:#eee; font-size:0.7rem; text-align:center;">Vittoria per: ${m.method}</div>` : ''}
        `;
        
        // Se clicchi sulla card, apri gestione
        card.onclick = (e) => {
            // Evita doppio click se clicchi sull'icona ingranaggio
            if(e.target.closest('.card-header')) return; 
            openModal(m.id);
        };

        return card;
    }

    // ================= GESTIONE MATCH (CORE LOGIC) =================
    function openModal(id) {
        const m = db.find(x => x.id === id);
        if(!m) return;
        
        editingMatchId = id;
        document.getElementById('matchModal').style.display = 'flex';
        document.getElementById('modalMatchId').innerText = "Gestione Match " + id;
        
        document.getElementById('modalP1').innerText = m.p1 || "---";
        document.getElementById('modalP1Club').innerText = m.p1i || "";
        
        document.getElementById('modalP2').innerText = m.p2 || "---";
        document.getElementById('modalP2Club').innerText = m.p2i || "";

        document.getElementById('winMethod').value = m.method || "PUNTI";
    }

    function closeModal() {
        document.getElementById('matchModal').style.display = 'none';
        editingMatchId = null;
    }

    function setWinner(winnerCode) {
        if(!editingMatchId) return;
        const m = db.find(x => x.id === editingMatchId);
        
        // Controlli di sicurezza
        if(winnerCode === 'p1' && (!m.p1 || m.p1 === "BYE")) return alert("Atleta Rosso non valido");
        if(winnerCode === 'p2' && (!m.p2 || m.p2 === "BYE")) return alert("Atleta Blu non valido");

        const winnerName = winnerCode === 'p1' ? m.p1 : m.p2;
        const winnerInfo = winnerCode === 'p1' ? m.p1i : m.p2i;
        
        m.w = winnerCode; // 'p1' o 'p2'
        m.method = document.getElementById('winMethod').value;
        
        // === LOGICA AVANZAMENTO (Topology) ===
        // Se il match ha un next_id, spostiamo il vincitore
        if(m.next_id) {
            const nextMatch = db.find(x => x.id === m.next_id);
            if(nextMatch) {
                // slot deve essere 'p1' o 'p2'
                if(m.next_slot === 'p1') {
                    nextMatch.p1 = winnerName;
                    nextMatch.p1i = winnerInfo;
                } else if(m.next_slot === 'p2') {
                    nextMatch.p2 = winnerName;
                    nextMatch.p2i = winnerInfo;
                }
                console.log(`Avanzamento: ${winnerName} va al match ${m.next_id} slot ${m.next_slot}`);
            }
        }

        saveDB();
        closeModal();
        loadCategory(currentCat);
    }

    function resetMatch() {
        if(!confirm("Resettare il risultato e rimuovere l'atleta dai turni successivi?")) return;
        
        const m = db.find(x => x.id === editingMatchId);
        m.w = null;
        m.method = null;
        
        // Reset a cascata (Se avevamo già mandato qualcuno avanti, lo togliamo)
        if(m.next_id) {
            const nextMatch = db.find(x => x.id === m.next_id);
            if(nextMatch) {
                if(m.next_slot === 'p1') { nextMatch.p1 = ""; nextMatch.p1i = ""; }
                if(m.next_slot === 'p2') { nextMatch.p2 = ""; nextMatch.p2i = ""; }
                // Ricorsione? Se resetto il match dopo, devo resettare anche quello dopo ancora...
                // Per ora resetta solo il prossimo step per sicurezza.
            }
        }
        
        saveDB();
        closeModal();
        loadCategory(currentCat);
    }

    function editAthletes() {
        const m = db.find(x => x.id === editingMatchId);
        const newP1 = prompt("Nome Atleta Rosso:", m.p1);
        if(newP1 !== null) m.p1 = newP1;
        
        const newP2 = prompt("Nome Atleta Blu:", m.p2);
        if(newP2 !== null) m.p2 = newP2;
        
        saveDB();
        closeModal();
        loadCategory(currentCat);
    }

    // ================= PERSISTENZA =================
    async function saveDB() {
        // Salva locale subito
        localStorage.setItem('tsk_db', JSON.stringify(db));
        
        // Salva Cloud background
        document.getElementById('syncStatus').innerHTML = '<i class="fas fa-sync fa-spin"></i> Salvataggio...';
        try {
            await fetch(API_URL, {
                method: "POST",
                body: JSON.stringify(db)
            });
            showStatus(true);
        } catch(e) {
            console.error("Save error", e);
            showStatus(false);
        }
    }

    function forceSave() {
        saveDB();
        alert("Salvataggio forzato avviato.");
    }

    // START
    window.onload = init;

</script>
</body>
</html>
